{"ast":null,"code":"'use strict';\n\nconst Document = require('../document');\n\nconst immediate = require('../helpers/immediate');\n\nconst internalToObjectOptions = require('../options').internalToObjectOptions;\n\nconst promiseOrCallback = require('../helpers/promiseOrCallback');\n\nconst documentArrayParent = require('../helpers/symbols').documentArrayParent;\n\nmodule.exports = Subdocument;\n/**\n * Subdocument constructor.\n *\n * @inherits Document\n * @api private\n */\n\nfunction Subdocument(value, fields, parent, skipId, options) {\n  this.$isSingleNested = true;\n  const hasPriorDoc = options != null && options.priorDoc;\n  let initedPaths = null;\n\n  if (hasPriorDoc) {\n    this._doc = Object.assign({}, options.priorDoc._doc);\n    delete this._doc[this.schema.options.discriminatorKey];\n    initedPaths = Object.keys(options.priorDoc._doc || {}).filter(key => key !== this.schema.options.discriminatorKey);\n  }\n\n  if (parent != null) {\n    // If setting a nested path, should copy isNew from parent re: gh-7048\n    options = Object.assign({}, options, {\n      isNew: parent.isNew,\n      defaults: parent.$__.$options.defaults\n    });\n  }\n\n  Document.call(this, value, fields, skipId, options);\n\n  if (hasPriorDoc) {\n    for (const key of initedPaths) {\n      if (!this.$__.activePaths.states.modify[key] && !this.$__.activePaths.states.default[key] && !this.$__.$setCalled.has(key)) {\n        const schematype = this.schema.path(key);\n        const def = schematype == null ? void 0 : schematype.getDefault(this);\n\n        if (def === void 0) {\n          delete this._doc[key];\n        } else {\n          this._doc[key] = def;\n          this.$__.activePaths.default(key);\n        }\n      }\n    }\n\n    delete options.priorDoc;\n    delete this.$__.$options.priorDoc;\n  }\n}\n\nSubdocument.prototype = Object.create(Document.prototype);\n\nSubdocument.prototype.toBSON = function () {\n  return this.toObject(internalToObjectOptions);\n};\n/**\n * Used as a stub for middleware\n *\n * ####NOTE:\n *\n * _This is a no-op. Does not actually save the doc to the db._\n *\n * @param {Function} [fn]\n * @return {Promise} resolved Promise\n * @api private\n */\n\n\nSubdocument.prototype.save = function (options, fn) {\n  if (typeof options === 'function') {\n    fn = options;\n    options = {};\n  }\n\n  options = options || {};\n\n  if (!options.suppressWarning) {\n    console.warn('mongoose: calling `save()` on a subdoc does **not** save ' + 'the document to MongoDB, it only runs save middleware. ' + 'Use `subdoc.save({ suppressWarning: true })` to hide this warning ' + 'if you\\'re sure this behavior is right for your app.');\n  }\n\n  return promiseOrCallback(fn, cb => {\n    this.$__save(cb);\n  });\n};\n/**\n * Used as a stub for middleware\n *\n * ####NOTE:\n *\n * _This is a no-op. Does not actually save the doc to the db._\n *\n * @param {Function} [fn]\n * @method $__save\n * @api private\n */\n\n\nSubdocument.prototype.$__save = function (fn) {\n  return immediate(() => fn(null, this));\n};\n\nSubdocument.prototype.$isValid = function (path) {\n  if (this.$parent && this.$basePath) {\n    return this.$parent.$isValid([this.$basePath, path].join('.'));\n  }\n\n  return Document.prototype.$isValid.call(this, path);\n};\n\nSubdocument.prototype.markModified = function (path) {\n  Document.prototype.markModified.call(this, path);\n\n  if (this.$parent && this.$basePath) {\n    if (this.$parent.isDirectModified(this.$basePath)) {\n      return;\n    }\n\n    this.$parent.markModified([this.$basePath, path].join('.'), this);\n  }\n};\n\nSubdocument.prototype.isModified = function (paths, modifiedPaths) {\n  if (this.$parent && this.$basePath) {\n    if (Array.isArray(paths) || typeof paths === 'string') {\n      paths = Array.isArray(paths) ? paths : paths.split(' ');\n      paths = paths.map(p => [this.$basePath, p].join('.'));\n      return this.$parent.isModified(paths, modifiedPaths);\n    }\n\n    return this.$parent.isModified(this.$basePath);\n  }\n\n  return Document.prototype.isModified.call(this, paths, modifiedPaths);\n};\n/**\n * Marks a path as valid, removing existing validation errors.\n *\n * @param {String} path the field to mark as valid\n * @api private\n * @method $markValid\n * @receiver Subdocument\n */\n\n\nSubdocument.prototype.$markValid = function (path) {\n  Document.prototype.$markValid.call(this, path);\n\n  if (this.$parent && this.$basePath) {\n    this.$parent.$markValid([this.$basePath, path].join('.'));\n  }\n};\n/*!\n * ignore\n */\n\n\nSubdocument.prototype.invalidate = function (path, err, val) {\n  // Hack: array subdocuments' validationError is equal to the owner doc's,\n  // so validating an array subdoc gives the top-level doc back. Temporary\n  // workaround for #5208 so we don't have circular errors.\n  if (err !== this.ownerDocument().$__.validationError) {\n    Document.prototype.invalidate.call(this, path, err, val);\n  }\n\n  if (this.$parent && this.$basePath) {\n    this.$parent.invalidate([this.$basePath, path].join('.'), err, val);\n  } else if (err.kind === 'cast' || err.name === 'CastError') {\n    throw err;\n  }\n\n  return this.ownerDocument().$__.validationError;\n};\n/*!\n * ignore\n */\n\n\nSubdocument.prototype.$ignore = function (path) {\n  Document.prototype.$ignore.call(this, path);\n\n  if (this.$parent && this.$basePath) {\n    this.$parent.$ignore([this.$basePath, path].join('.'));\n  }\n};\n/**\n * Returns the top level document of this sub-document.\n *\n * @return {Document}\n */\n\n\nSubdocument.prototype.ownerDocument = function () {\n  if (this.$__.ownerDocument) {\n    return this.$__.ownerDocument;\n  }\n\n  let parent = this.$parent;\n\n  if (!parent) {\n    return this;\n  }\n\n  while (parent.$parent || parent[documentArrayParent]) {\n    parent = parent.$parent || parent[documentArrayParent];\n  }\n\n  this.$__.ownerDocument = parent;\n  return this.$__.ownerDocument;\n};\n/**\n * Returns this sub-documents parent document.\n *\n * @api public\n */\n\n\nSubdocument.prototype.parent = function () {\n  return this.$parent;\n};\n/*!\n * no-op for hooks\n */\n\n\nSubdocument.prototype.$__remove = function (cb) {\n  return cb(null, this);\n};\n/**\n * Null-out this subdoc\n *\n * @param {Object} [options]\n * @param {Function} [callback] optional callback for compatibility with Document.prototype.remove\n */\n\n\nSubdocument.prototype.remove = function (options, callback) {\n  if (typeof options === 'function') {\n    callback = options;\n    options = null;\n  }\n\n  registerRemoveListener(this); // If removing entire doc, no need to remove subdoc\n\n  if (!options || !options.noop) {\n    this.$parent.set(this.$basePath, null);\n  }\n\n  if (typeof callback === 'function') {\n    callback(null);\n  }\n};\n/*!\n * ignore\n */\n\n\nSubdocument.prototype.populate = function () {\n  throw new Error('Mongoose does not support calling populate() on nested ' + 'docs. Instead of `doc.nested.populate(\"path\")`, use ' + '`doc.populate(\"nested.path\")`');\n};\n/*!\n * Registers remove event listeners for triggering\n * on subdocuments.\n *\n * @param {Subdocument} sub\n * @api private\n */\n\n\nfunction registerRemoveListener(sub) {\n  let owner = sub.ownerDocument();\n\n  function emitRemove() {\n    owner.removeListener('save', emitRemove);\n    owner.removeListener('remove', emitRemove);\n    sub.emit('remove', sub);\n    sub.constructor.emit('remove', sub);\n    owner = sub = null;\n  }\n\n  owner.on('save', emitRemove);\n  owner.on('remove', emitRemove);\n}","map":{"version":3,"sources":["C:/Users/Thakshan/Desktop/BookCorner/node_modules/mongoose/lib/types/subdocument.js"],"names":["Document","require","immediate","internalToObjectOptions","promiseOrCallback","documentArrayParent","module","exports","Subdocument","value","fields","parent","skipId","options","$isSingleNested","hasPriorDoc","priorDoc","initedPaths","_doc","Object","assign","schema","discriminatorKey","keys","filter","key","isNew","defaults","$__","$options","call","activePaths","states","modify","default","$setCalled","has","schematype","path","def","getDefault","prototype","create","toBSON","toObject","save","fn","suppressWarning","console","warn","cb","$__save","$isValid","$parent","$basePath","join","markModified","isDirectModified","isModified","paths","modifiedPaths","Array","isArray","split","map","p","$markValid","invalidate","err","val","ownerDocument","validationError","kind","name","$ignore","$__remove","remove","callback","registerRemoveListener","noop","set","populate","Error","sub","owner","emitRemove","removeListener","emit","constructor","on"],"mappings":"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","sourcesContent":["'use strict';\n\nconst Document = require('../document');\nconst immediate = require('../helpers/immediate');\nconst internalToObjectOptions = require('../options').internalToObjectOptions;\nconst promiseOrCallback = require('../helpers/promiseOrCallback');\n\nconst documentArrayParent = require('../helpers/symbols').documentArrayParent;\n\nmodule.exports = Subdocument;\n\n/**\n * Subdocument constructor.\n *\n * @inherits Document\n * @api private\n */\n\nfunction Subdocument(value, fields, parent, skipId, options) {\n  this.$isSingleNested = true;\n\n  const hasPriorDoc = options != null && options.priorDoc;\n  let initedPaths = null;\n  if (hasPriorDoc) {\n    this._doc = Object.assign({}, options.priorDoc._doc);\n    delete this._doc[this.schema.options.discriminatorKey];\n    initedPaths = Object.keys(options.priorDoc._doc || {}).\n      filter(key => key !== this.schema.options.discriminatorKey);\n  }\n  if (parent != null) {\n    // If setting a nested path, should copy isNew from parent re: gh-7048\n    options = Object.assign({}, options, {\n      isNew: parent.isNew,\n      defaults: parent.$__.$options.defaults\n    });\n  }\n  Document.call(this, value, fields, skipId, options);\n\n  if (hasPriorDoc) {\n    for (const key of initedPaths) {\n      if (!this.$__.activePaths.states.modify[key] &&\n          !this.$__.activePaths.states.default[key] &&\n          !this.$__.$setCalled.has(key)) {\n        const schematype = this.schema.path(key);\n        const def = schematype == null ? void 0 : schematype.getDefault(this);\n        if (def === void 0) {\n          delete this._doc[key];\n        } else {\n          this._doc[key] = def;\n          this.$__.activePaths.default(key);\n        }\n      }\n    }\n\n    delete options.priorDoc;\n    delete this.$__.$options.priorDoc;\n  }\n}\n\nSubdocument.prototype = Object.create(Document.prototype);\n\nSubdocument.prototype.toBSON = function() {\n  return this.toObject(internalToObjectOptions);\n};\n\n/**\n * Used as a stub for middleware\n *\n * ####NOTE:\n *\n * _This is a no-op. Does not actually save the doc to the db._\n *\n * @param {Function} [fn]\n * @return {Promise} resolved Promise\n * @api private\n */\n\nSubdocument.prototype.save = function(options, fn) {\n  if (typeof options === 'function') {\n    fn = options;\n    options = {};\n  }\n  options = options || {};\n\n  if (!options.suppressWarning) {\n    console.warn('mongoose: calling `save()` on a subdoc does **not** save ' +\n      'the document to MongoDB, it only runs save middleware. ' +\n      'Use `subdoc.save({ suppressWarning: true })` to hide this warning ' +\n      'if you\\'re sure this behavior is right for your app.');\n  }\n\n  return promiseOrCallback(fn, cb => {\n    this.$__save(cb);\n  });\n};\n\n/**\n * Used as a stub for middleware\n *\n * ####NOTE:\n *\n * _This is a no-op. Does not actually save the doc to the db._\n *\n * @param {Function} [fn]\n * @method $__save\n * @api private\n */\n\nSubdocument.prototype.$__save = function(fn) {\n  return immediate(() => fn(null, this));\n};\n\nSubdocument.prototype.$isValid = function(path) {\n  if (this.$parent && this.$basePath) {\n    return this.$parent.$isValid([this.$basePath, path].join('.'));\n  }\n  return Document.prototype.$isValid.call(this, path);\n};\n\nSubdocument.prototype.markModified = function(path) {\n  Document.prototype.markModified.call(this, path);\n\n  if (this.$parent && this.$basePath) {\n    if (this.$parent.isDirectModified(this.$basePath)) {\n      return;\n    }\n    this.$parent.markModified([this.$basePath, path].join('.'), this);\n  }\n};\n\nSubdocument.prototype.isModified = function(paths, modifiedPaths) {\n  if (this.$parent && this.$basePath) {\n    if (Array.isArray(paths) || typeof paths === 'string') {\n      paths = (Array.isArray(paths) ? paths : paths.split(' '));\n      paths = paths.map(p => [this.$basePath, p].join('.'));\n\n      return this.$parent.isModified(paths, modifiedPaths);\n    }\n\n    return this.$parent.isModified(this.$basePath);\n  }\n\n  return Document.prototype.isModified.call(this, paths, modifiedPaths);\n};\n\n/**\n * Marks a path as valid, removing existing validation errors.\n *\n * @param {String} path the field to mark as valid\n * @api private\n * @method $markValid\n * @receiver Subdocument\n */\n\nSubdocument.prototype.$markValid = function(path) {\n  Document.prototype.$markValid.call(this, path);\n  if (this.$parent && this.$basePath) {\n    this.$parent.$markValid([this.$basePath, path].join('.'));\n  }\n};\n\n/*!\n * ignore\n */\n\nSubdocument.prototype.invalidate = function(path, err, val) {\n  // Hack: array subdocuments' validationError is equal to the owner doc's,\n  // so validating an array subdoc gives the top-level doc back. Temporary\n  // workaround for #5208 so we don't have circular errors.\n  if (err !== this.ownerDocument().$__.validationError) {\n    Document.prototype.invalidate.call(this, path, err, val);\n  }\n\n  if (this.$parent && this.$basePath) {\n    this.$parent.invalidate([this.$basePath, path].join('.'), err, val);\n  } else if (err.kind === 'cast' || err.name === 'CastError') {\n    throw err;\n  }\n\n  return this.ownerDocument().$__.validationError;\n};\n\n/*!\n * ignore\n */\n\nSubdocument.prototype.$ignore = function(path) {\n  Document.prototype.$ignore.call(this, path);\n  if (this.$parent && this.$basePath) {\n    this.$parent.$ignore([this.$basePath, path].join('.'));\n  }\n};\n\n/**\n * Returns the top level document of this sub-document.\n *\n * @return {Document}\n */\n\nSubdocument.prototype.ownerDocument = function() {\n  if (this.$__.ownerDocument) {\n    return this.$__.ownerDocument;\n  }\n\n  let parent = this.$parent;\n  if (!parent) {\n    return this;\n  }\n\n  while (parent.$parent || parent[documentArrayParent]) {\n    parent = parent.$parent || parent[documentArrayParent];\n  }\n\n  this.$__.ownerDocument = parent;\n  return this.$__.ownerDocument;\n};\n\n/**\n * Returns this sub-documents parent document.\n *\n * @api public\n */\n\nSubdocument.prototype.parent = function() {\n  return this.$parent;\n};\n\n/*!\n * no-op for hooks\n */\n\nSubdocument.prototype.$__remove = function(cb) {\n  return cb(null, this);\n};\n\n/**\n * Null-out this subdoc\n *\n * @param {Object} [options]\n * @param {Function} [callback] optional callback for compatibility with Document.prototype.remove\n */\n\nSubdocument.prototype.remove = function(options, callback) {\n  if (typeof options === 'function') {\n    callback = options;\n    options = null;\n  }\n\n  registerRemoveListener(this);\n\n  // If removing entire doc, no need to remove subdoc\n  if (!options || !options.noop) {\n    this.$parent.set(this.$basePath, null);\n  }\n\n  if (typeof callback === 'function') {\n    callback(null);\n  }\n};\n\n/*!\n * ignore\n */\n\nSubdocument.prototype.populate = function() {\n  throw new Error('Mongoose does not support calling populate() on nested ' +\n    'docs. Instead of `doc.nested.populate(\"path\")`, use ' +\n    '`doc.populate(\"nested.path\")`');\n};\n\n/*!\n * Registers remove event listeners for triggering\n * on subdocuments.\n *\n * @param {Subdocument} sub\n * @api private\n */\n\nfunction registerRemoveListener(sub) {\n  let owner = sub.ownerDocument();\n\n  function emitRemove() {\n    owner.removeListener('save', emitRemove);\n    owner.removeListener('remove', emitRemove);\n    sub.emit('remove', sub);\n    sub.constructor.emit('remove', sub);\n    owner = sub = null;\n  }\n\n  owner.on('save', emitRemove);\n  owner.on('remove', emitRemove);\n}\n"]},"metadata":{},"sourceType":"script"}